(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{240:function(s,a,t){s.exports=t.p+"assets/img/apps-monorepo_1.be622989.png"},278:function(s,a,t){s.exports=t.p+"assets/img/what-is-monorepo_1.f3da7cb8.png"},279:function(s,a,t){s.exports=t.p+"assets/img/what-is-monorepo_2.d01fcc5d.png"},280:function(s,a,t){s.exports=t.p+"assets/img/what-is-monorepo_3.d0b31353.png"},281:function(s,a,t){s.exports=t.p+"assets/img/what-is-monorepo_4.0ab6b4f1.png"},303:function(s,a,t){"use strict";t.r(a);var n=t(13),r=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"monorepo-初探"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#monorepo-初探"}},[s._v("#")]),s._v(" Monorepo 初探")]),s._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#什么是-monorepo"}},[s._v("什么是 monorepo?")]),a("ul",[a("li",[a("a",{attrs:{href:"#优缺点"}},[s._v("优缺点")])]),a("li",[a("a",{attrs:{href:"#与-monorepo-对应的是-multirepo"}},[s._v("与 monorepo 对应的是 multirepo")])])])]),a("li",[a("a",{attrs:{href:"#创建一个-monorepo-项目"}},[s._v("创建一个 monorepo 项目")]),a("ul",[a("li",[a("a",{attrs:{href:"#众说纷纭"}},[s._v("众说纷纭")])]),a("li",[a("a",{attrs:{href:"#一、yarn-workspaces"}},[s._v("一、yarn workspaces")])]),a("li",[a("a",{attrs:{href:"#二、lerna-5-1"}},[s._v("二、lerna 5.1+")])])])])])]),a("p"),s._v(" "),a("blockquote",[a("p",[s._v("monorepo 本身并不是一个新的概念，只是旧事重提")])]),s._v(" "),a("h2",{attrs:{id:"什么是-monorepo"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是-monorepo"}},[s._v("#")]),s._v(" 什么是 monorepo?")]),s._v(" "),a("p",[s._v("单个代码库里包含了许多项目的代码，这些项目虽然有可能是相关，但通常在逻辑上是独立的，并由不同的“团队[每个人都可以是一个团队]”维护 的 一种代码管理策略。")]),s._v(" "),a("h3",{attrs:{id:"优缺点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优缺点"}},[s._v("#")]),s._v(" 优缺点")]),s._v(" "),a("p",[s._v("优点：")]),s._v(" "),a("ul",[a("li",[s._v("易于代码重用")]),s._v(" "),a("li",[s._v("简化依赖管理，")]),s._v(" "),a("li",[s._v("大规模代码重构")]),s._v(" "),a("li",[s._v("跨团队协作")])]),s._v(" "),a("p",[s._v("缺点：")]),s._v(" "),a("ul",[a("li",[s._v("新人学习成本比较高")]),s._v(" "),a("li",[s._v("缺乏每个项目的访问控制")]),s._v(" "),a("li",[s._v("默认情况下需要更多的存储空间")])]),s._v(" "),a("h3",{attrs:{id:"与-monorepo-对应的是-multirepo"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#与-monorepo-对应的是-multirepo"}},[s._v("#")]),s._v(" 与 monorepo 对应的是 multirepo")]),s._v(" "),a("p",[s._v("multirepo 则是通过多个仓库的方式来管理每一个模块、功能或者应用。无论是 monorepo 或者 multirepo，都只是一种软件开发中代码的管理策略，本身并无孰优孰劣的区别，也不是非 mono 即 multi 的问题。")]),s._v(" "),a("p",[s._v("如图：")]),s._v(" "),a("p",[a("img",{attrs:{src:t(240),alt:""}})]),s._v(" "),a("h2",{attrs:{id:"创建一个-monorepo-项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建一个-monorepo-项目"}},[s._v("#")]),s._v(" 创建一个 monorepo 项目")]),s._v(" "),a("h3",{attrs:{id:"众说纷纭"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#众说纷纭"}},[s._v("#")]),s._v(" 众说纷纭")]),s._v(" "),a("p",[s._v("脉脉某个程序抛出了个问题“现在前端搞 monorepo 比较好的方案有没有”")]),s._v(" "),a("ul",[a("li",[s._v("yarn+workspaces")]),s._v(" "),a("li",[s._v("lerna")]),s._v(" "),a("li",[s._v("rush + pnpm")]),s._v(" "),a("li",[s._v("pnpm workspace")]),s._v(" "),a("li",[s._v("pnpm + @abmao/pkgs")]),s._v(" "),a("li",[s._v("pnpm +turborepo+changesets（pnpm workspace 做拆分，changeset 做版本控制，turborepo 做多线程打包） , 水平够上 rush。\n"),a("ul",[a("li",[s._v("这三套加起来就是 rush。")])])]),s._v(" "),a("li",[s._v("rush or pnpm + workspace")]),s._v(" "),a("li",[s._v("lerna + (yarn + workspace)")])]),s._v(" "),a("h3",{attrs:{id:"一、yarn-workspaces"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、yarn-workspaces"}},[s._v("#")]),s._v(" 一、yarn workspaces")]),s._v(" "),a("h4",{attrs:{id:"hoist-nohoist"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#hoist-nohoist"}},[s._v("#")]),s._v(" hoist & nohoist")]),s._v(" "),a("p",[s._v("hoist /hɔɪst/")]),s._v(" "),a("p",[s._v("hoist： 将公共的依赖包提取出来，集中到同一层目录下。如下图：")]),s._v(" "),a("p",[a("img",{attrs:{src:t(278),alt:""}})]),s._v(" "),a("p",[s._v("事实上，在有些时候，在打包子项目的时候，会出现模块找不到的情况，例如 package-1 打包的时候，依赖的 A（1.0）可以在 node_module,找到 B(1.0)，但是 C(1.0)并不一定是支持 monorepo 模式的第三方库。如下图：")]),s._v(" "),a("p",[a("img",{attrs:{src:t(279),alt:""}})]),s._v(" "),a("p",[s._v("nohoist\n是一种处理对 monorepo 不兼容的第三方库的一个方案，可以通过配置 nohoist 指定 yarn 不对该模板进行提示。如：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//根目录package.json")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"workspance"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"packages"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"packages/*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"nohoist"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"**/react-native"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"**/react-native/**"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//子项目，不使用nohoist")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"workspaces"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"packages"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"packages/*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//子项目，使用nohoist")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"workspaces"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"nohoist"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"react-native"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"react-native/**"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[a("img",{attrs:{src:t(280),alt:""}})]),s._v(" "),a("h4",{attrs:{id:"什么是-workspace"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是-workspace"}},[s._v("#")]),s._v(" 什么是 workspace")]),s._v(" "),a("ol",[a("li",[s._v("当项目中的 package 有依赖关系时，workspace 会自动对 package 的引用设置软链接（symlink）,且链接仅限于当前的 workspace。")]),s._v(" "),a("li",[s._v("所有的 package 的依赖都会安装在根目录的 node_modules，节省一定的空间。")]),s._v(" "),a("li",[s._v("依赖同一份 yarn.lock。")])]),s._v(" "),a("h4",{attrs:{id:"使用-workspace"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-workspace"}},[s._v("#")]),s._v(" 使用 workspace")]),s._v(" "),a("p",[s._v("配置 package.json")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//package.json")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"monorepo-demo"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"private"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"workspaces"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"packages/*"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n设置根目录的内容不发布。\nworkspaces\n声明workspace中"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v("的路径。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h5",{attrs:{id:"项目运行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#项目运行"}},[s._v("#")]),s._v(" 项目运行")]),s._v(" "),a("p",[a("code",[s._v("yarn workspace [package-name] commond")])]),s._v(" "),a("h5",{attrs:{id:"例如"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#例如"}},[s._v("#")]),s._v(" 例如")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("-monorepo\n  -packages\n    -hy-gift-display\n    -pw-coolect\n-package.json\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("mult: "),a("code",[s._v("npm run start")])]),s._v(" "),a("p",[s._v("mono: "),a("code",[s._v("yarn workspace hy-gift-display run start")])]),s._v(" "),a("h5",{attrs:{id:"查看-workspace-依赖树"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看-workspace-依赖树"}},[s._v("#")]),s._v(" 查看 workspace 依赖树")]),s._v(" "),a("p",[a("code",[s._v("yarn workspaces info --json")])]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("npm包整合demo\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"app1"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"location"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"packages/app1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"workspaceDependencies"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"mismatchedWorkspaceDependencies"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"jsfunc"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"app2"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"location"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"packages/app2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"workspaceDependencies"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"jsfunc"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"mismatchedWorkspaceDependencies"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"app3"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"location"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"packages/app3"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"workspaceDependencies"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"mismatchedWorkspaceDependencies"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"app4"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"location"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"packages/app4"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"workspaceDependencies"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"mismatchedWorkspaceDependencies"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"jsfunc"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"location"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"packages/jsfunc"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"workspaceDependencies"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"mismatchedWorkspaceDependencies"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br")])]),a("p",[s._v("workspaceDependencies: 工作区内依赖的 package")]),s._v(" "),a("p",[s._v("mismatchedWorkspaceDependencies：工作区内依赖的 package，但版本不匹配。")]),s._v(" "),a("h5",{attrs:{id:"问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[s._v("#")]),s._v(" 问题：")]),s._v(" "),a("ul",[a("li",[s._v("当一个子项目更新后，只能手动追踪依赖更新版本。")])]),s._v(" "),a("h3",{attrs:{id:"二、lerna-5-1"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、lerna-5-1"}},[s._v("#")]),s._v(" 二、lerna 5.1+")]),s._v(" "),a("p",[s._v("什么是 lerna？在 yarn 1.x workspace 官方的文档里面有这样一段描述。")]),s._v(" "),a("p",[s._v("Yarn’s workspaces are the low-level primitives that tools like Lerna can (and do!) use.")]),s._v(" "),a("p",[s._v("yarn 对于 lerna 的描述是一个更好的一个解决方案/用法，也明确表示不会去支持类似 lerna 中的功能。那在 lerna 的官网的描述是这样的，“是一个管理工具，用于管理包含多个软件包（package）的 JavaScript 项目。”")]),s._v(" "),a("h4",{attrs:{id:"开始一个-lerna-项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开始一个-lerna-项目"}},[s._v("#")]),s._v(" 开始一个 lerna 项目")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/lerna/getting-started-example",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/lerna/getting-started-example"),a("OutboundLink")],1),s._v(" 可以直接拉取这个案例在本地尝试。")]),s._v(" "),a("p",[a("code",[s._v("$ npx lerna init")])]),s._v(" "),a("p",[s._v("多了一个 lerna.json")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"packages"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"packages/*"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"useNx"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"version"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("packages: 指定 workspace 的目录")]),s._v(" "),a("p",[s._v("useNx: 是否使用 Nx。")]),s._v(" "),a("p",[a("strong",[s._v("packages 很好理解，那什么是 Nx？")])]),s._v(" "),a("p",[s._v("Smart,Fast and Extendsible Build System. Next generation build sysem with first class monorepo support and powerful integrations.")]),s._v(" "),a("p",[s._v("这是一个可以独立使用的 monorepo 的构建系统，具体可以看官网，在 learn 中，nx 扮演的角色是“缓存已构建内容”， 默认情况下，本地缓存有效期为一周，一周后将自动清除。")]),s._v(" "),a("p",[s._v("nx 除了扮演缓存的角色之后，还有一个我们可以用到的功能，就是可视化 monorepo 项目之间的依赖管理，如：")]),s._v(" "),a("p",[a("code",[s._v("$ npx nx grap")])]),s._v(" "),a("p",[s._v("某仓库内 pacekge 的关系如下：")]),s._v(" "),a("p",[a("img",{attrs:{src:t(281),alt:""}})]),s._v(" "),a("h4",{attrs:{id:"常用命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用命令"}},[s._v("#")]),s._v(" 常用命令")]),s._v(" "),a("p",[a("code",[s._v("$ lerna boostrap")])]),s._v(" "),a("p",[s._v("当在一个 lerna-monorepo 项目运行 boostrap，会进行以下行为：")]),s._v(" "),a("ol",[a("li",[s._v("在各个 packages 内执行 npm install")]),s._v(" "),a("li",[s._v("将 packages 相互引用的子应用引用关联，让子应用之间可以像 npm 包那样调用，类似 npm link")])]),s._v(" "),a("p",[s._v("注意：项目初始化需要执行。")]),s._v(" "),a("p",[a("code",[s._v("$ lerna run scriptName")])]),s._v(" "),a("p",[s._v("运行 script，例如")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("//demo1\n$lerna run build\n*等同于在所有子应用都运行 npm run build;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("details",{staticClass:"custom-block details"},[a("summary",[s._v("配置项")]),s._v(" "),a("p",[a("code",[s._v("--scope")])]),s._v(" "),a("p",[s._v("指定某个自引用运行 script。")]),s._v(" "),a("p",[a("code",[s._v("--stream")])]),s._v(" "),a("p",[s._v("leran 输出子应用打包子进程相关日志。")]),s._v(" "),a("p",[a("code",[s._v("--concurrency")])]),s._v(" "),a("p",[s._v("指定数量并发执行 script。")])]),s._v(" "),a("p",[a("code",[s._v("$ lerna clean")])]),s._v(" "),a("p",[s._v("清除子应用 node_module、monorepo 根目录 node_module")]),s._v(" "),a("p",[a("code",[s._v("$ lerna add <package>[@version] [--dev] [--exact] [--peer]")])]),s._v(" "),a("details",{staticClass:"custom-block details"},[a("summary",[s._v("配置项")]),s._v(" "),a("p",[a("code",[s._v("--dev")])]),s._v(" "),a("p",[s._v("packages 添加到 devDependencies")]),s._v(" "),a("p",[a("code",[s._v("--exact")])]),s._v(" "),a("p",[s._v("需要精确版本，例如 1.1.0 而不是^1.1.0")]),s._v(" "),a("p",[a("code",[s._v("--peer")]),s._v("\npackages 添加到 peerDependencies")])]),s._v(" "),a("p",[a("code",[s._v("$ lerna import")])]),s._v(" "),a("p",[s._v("用于旧项目迁移，迁移 mulit 应用到 monorepo 项目底下，迁移的同时，会同时同步 master 的所有 commit，例如")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("参考")]),s._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"https://fed.taobao.org/blog/taofed/do71ct/uihagy/",target:"_blank",rel:"noopener noreferrer"}},[s._v("All in one：项目级 monorepo 策略最佳实践"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.robinwieruch.de/javascript-monorepos/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Monorepos in JavaScript & TypeScript"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.yuque.com/docs/share/69ee97ff-42cc-46cf-a409-31967339a9cf",target:"_blank",rel:"noopener noreferrer"}},[s._v("monorepo 设计思路"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s/X6eehnbs055Gmiw56Zs_DA",target:"_blank",rel:"noopener noreferrer"}},[s._v("深入浅出 npm & yarn & pnpm 包管理机制"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://classic.yarnpkg.com/blog/2018/02/15/nohoist/",target:"_blank",rel:"noopener noreferrer"}},[s._v("nohoist in Workspaces"),a("OutboundLink")],1)])])])])}),[],!1,null,null,null);a.default=r.exports}}]);